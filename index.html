<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ•ãƒ¬ã‚¢ãƒœãƒ ã‚ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</title>
    <style>
        body {
            /* ... å¤‰æ›´ãªã— ... */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
        }

        #video-container {
            position: relative;
            /* === ä¿®æ­£ç‚¹: ç”»é¢ã‚µã‚¤ã‚ºã„ã£ã±ã„ã«åºƒãŒã‚Šã€æ¯”ç‡ã‚’ç¶­æŒã™ã‚‹è¨­å®š === */
            width: 90vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¹…ã®90% */
            height: calc(90vw * 0.75); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®16:9ï¼ˆ0.5625ï¼‰ã‚ˆã‚Šã‚‚æ±ç”¨çš„ãª4:3ï¼ˆ0.75ï¼‰ã‚’ä½¿ç”¨ */
            max-width: 90vh; /* ç¸¦é•·ç”»é¢ã®å ´åˆã¯é«˜ã•ã‚‚è€ƒæ…® */
            max-height: 90vh;
            /* ========================================================== */
            margin-bottom: 10px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å°‘ã—æ¸›ã‚‰ã™ */
            border: 2px solid #555;
            /* ç¸¦æ¨ªæ¯”ãŒç•°ãªã‚‹ã¨ãã«ç”»é¢ä¸­å¤®ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š */
            margin-left: auto;
            margin-right: auto;
        }

        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* æ˜ åƒãŒã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            object-fit: contain; 
        }

        #status {
            font-size: 1.2em;
            margin-top: 10px;
        }

        #controls {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
        }

        #controls label {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>ğŸ”¥ ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ•ãƒ¬ã‚¢ãƒœãƒ ã‚ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</h1>
    <div id="video-container">
        <video id="webcam" playsinline style="visibility: hidden;"></video>
        <canvas id="output_canvas"></canvas>
    </div>
    <div id="status">æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ã€æŒ‡ã‚’ã¾ã£ã™ãã«ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚</div>
    
    <div id="controls">
        <input type="checkbox" id="showLandmarks" checked>
        <label for="showLandmarks">ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã¨éª¨æ ¼ã‚’è¡¨ç¤º</label>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <script>
        // ----------------------------------------------------
        // 1. è¦ç´ ã®å–å¾—ã¨åˆæœŸè¨­å®š
        // ----------------------------------------------------
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusElement = document.getElementById('status');
        const showLandmarksCheckbox = document.getElementById('showLandmarks'); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

        // æŒ‡ã”ã¨ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ID (æŒ‡ã®æ ¹å…ƒã€ç¬¬1é–¢ç¯€ã€ç¬¬2é–¢ç¯€ã€æŒ‡å…ˆ)
        const FINGER_LANDMARKS = {
            // [ä»˜ã‘æ ¹, ç¬¬1é–¢ç¯€, ç¬¬2é–¢ç¯€, æŒ‡å…ˆ]
            THUMB: [2, 3, 4], // è¦ªæŒ‡ã¯3ç‚¹ (ID 2, 3, 4)
            INDEX: [5, 6, 7, 8],
            MIDDLE: [9, 10, 11, 12],
            RING: [13, 14, 15, 16],
            PINKY: [17, 18, 19, 20]
        };

        const FIRE_STATUS = {
            THUMB: false,
            INDEX: false,
            MIDDLE: false,
            RING: false,
            PINKY: false
        };

        // ----------------------------------------------------
        // 2. æŒ‡ãŒã¾ã£ã™ãã‹åˆ¤å®šã™ã‚‹é–¢æ•°
        // ----------------------------------------------------

        /**
         * ç‰¹å®šã®æŒ‡ãŒã¾ã£ã™ãä¼¸ã³ã¦ã„ã‚‹ã‹åˆ¤å®šã™ã‚‹ï¼ˆè§’åº¦ãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“åˆ¤å®šï¼‰
         */
        function isFingerStraight(landmarks, fingerIds) {
            // === å …ç‰¢ãªãƒã‚§ãƒƒã‚¯ ===
            if (!landmarks || fingerIds.length < 3) {
                 return false;
            }
            if (fingerIds.some(id => !landmarks[id])) {
                 return false;
            }
            // ====================

            const p_base = landmarks[fingerIds[0]];
            const p_mid = landmarks[fingerIds[1]];
            const p_tip = landmarks[fingerIds[fingerIds.length - 1]];

            // ãƒ™ã‚¯ãƒˆãƒ« v1 = (p_mid - p_base), v2 = (p_tip - p_mid)
            const v1_x = p_mid.x - p_base.x;
            const v1_y = p_mid.y - p_base.y;
            const v2_x = p_tip.x - p_mid.x;
            const v2_y = p_tip.y - p_mid.y;

            // å†…ç©ã¨ãƒãƒ«ãƒ ï¼ˆé•·ã•ï¼‰ã‹ã‚‰è§’åº¦ã‚’è¨ˆç®—
            const dot_product = v1_x * v2_x + v1_y * v2_y;
            const magnitude1 = Math.sqrt(v1_x * v1_x + v1_y * v1_y);
            const magnitude2 = Math.sqrt(v2_x * v2_x + v2_y * v2_y);

            // ã‚¼ãƒ­é™¤ç®—ã®å›é¿
            if (magnitude1 * magnitude2 === 0) return false;
            const cos_theta = dot_product / (magnitude1 * magnitude2);

            // ã—ãã„å€¤
            const STRAIGHT_THRESHOLD = 0.90; 
            
            // è¦ªæŒ‡ã¯æ§‹é€ ä¸Šç‰¹æ®ŠãªãŸã‚ã€ã—ãã„å€¤ã‚’ç·©ã‚ã‚‹
            if (fingerIds.length === 3) {
                return cos_theta > 0.85; 
            }

            return cos_theta > STRAIGHT_THRESHOLD;
        }

        // ----------------------------------------------------
        // 3. ç‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
        // ----------------------------------------------------

        /**
         * æŒ‡å…ˆã«ç‚ã®ã‚ˆã†ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æç”»ã™ã‚‹
         */
        function drawFireEffect(landmarks, ctx) {
            // ã‚­ãƒ¼ã¨æŒ‡å…ˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯IDã®å¯¾å¿œ
            const TIP_MAP = {
                THUMB: 4,
                INDEX: 8,
                MIDDLE: 12,
                RING: 16,
                PINKY: 20
            };

            let activeFires = 0;
            
            // FIRE_STATUSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åå¾©å‡¦ç†
            for (const key in FIRE_STATUS) {
                if (FIRE_STATUS[key] === true) {
                    activeFires++;
                    const tipId = TIP_MAP[key];
                    const landmark = landmarks[tipId];

                    if (landmark) {
                        // åº§æ¨™ã‚’æ­£è¦åŒ–åº§æ¨™ã‹ã‚‰ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›
                        const x = landmark.x * canvasElement.width;
                        const y = landmark.y * canvasElement.height;
                        
                        // ç‚ã®è‰²ã¨ã¼ã‹ã—ã®è¨­å®š
                        ctx.shadowColor = 'orange';
                        ctx.shadowBlur = 15;
                        
                        // ç‚ã®æºã‚‰ãã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã€ä¸­å¿ƒåº§æ¨™ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã™
                        const wobbleX = (Math.random() - 0.5) * 5;
                        const wobbleY = (Math.random() - 0.5) * 5;

                        // ç‚ã®æç”» (å¤–å´ã‹ã‚‰å†…å´ã¸)
                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(255, 100, 0, 0.8)'; // èµ¤ã‚ªãƒ¬ãƒ³ã‚¸
                        ctx.arc(x + wobbleX, y + wobbleY, 20, 0, 2 * Math.PI); 
                        ctx.fill();

                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(255, 165, 0, 0.9)'; // ã‚ªãƒ¬ãƒ³ã‚¸
                        ctx.arc(x + wobbleX * 0.5, y + wobbleY * 0.5, 12, 0, 2 * Math.PI); 
                        ctx.fill();

                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(255, 255, 0, 1.0)'; // é»„è‰²ã„èŠ¯
                        ctx.arc(x, y, 6, 0, 2 * Math.PI); 
                        ctx.fill();
                    }
                }
            }

            // æç”»å¾Œã¯ã‚·ãƒ£ãƒ‰ã‚¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';

            if (activeFires == 0) {
                statusElement.textContent = "âœ‹ æŒ‡ã‚’ã¾ã£ã™ãã«ä¼¸ã°ã—ã¦ãƒ‘ãƒ¯ãƒ¼ã‚’æºœã‚ã¦ãã ã•ã„ã€‚";
            } else if (activeFires === 1) {
                statusElement.textContent = `ãƒ¡`;
            } else if (activeFires === 2) {
                statusElement.textContent = `ãƒ¡ãƒ©`;
            } else if (activeFires === 3) {
                statusElement.textContent = `ãƒ¡ãƒ©ã‚¾ãƒ¼`;
            } else if (activeFires === 4) {
                statusElement.textContent = `ãƒ¡ãƒ©ã‚¾ãƒ¼ãƒ`;
            } else {
                statusElement.textContent = `ğŸ”¥ äº”æŒ‡çˆ†ç‚å¼¾ï¼ˆãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ•ãƒ¬ã‚¢ãƒœãƒ ã‚ºï¼‰`;
            }
        }


        // ----------------------------------------------------
        // 4. MediaPipe Hands ã®åˆæœŸåŒ–ã¨å‡¦ç†
        // ----------------------------------------------------
        
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1, 
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        // æ¤œå‡ºçµæœãŒè¿”ã£ã¦ããŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // å·¦å³åè»¢ã®é©ç”¨ï¼ˆæ˜ åƒã¨æç”»ï¼‰
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-canvasElement.width, 0);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // ç‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            FIRE_STATUS.THUMB = false;
            FIRE_STATUS.INDEX = false;
            FIRE_STATUS.MIDDLE = false;
            FIRE_STATUS.RING = false;
            FIRE_STATUS.PINKY = false;


            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const handLandmarks = results.multiHandLandmarks[0];

                // æŒ‡ã®åˆ¤å®š
                FIRE_STATUS.THUMB = isFingerStraight(handLandmarks, FINGER_LANDMARKS.THUMB);
                FIRE_STATUS.INDEX = isFingerStraight(handLandmarks, FINGER_LANDMARKS.INDEX);
                FIRE_STATUS.MIDDLE = isFingerStraight(handLandmarks, FINGER_LANDMARKS.MIDDLE);
                FIRE_STATUS.RING = isFingerStraight(handLandmarks, FINGER_LANDMARKS.RING);
                FIRE_STATUS.PINKY = isFingerStraight(handLandmarks, FINGER_LANDMARKS.PINKY);

                // ç‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æç”»
                drawFireEffect(handLandmarks, canvasCtx);

                // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®æç”»ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«ä¾å­˜ï¼‰
                if (showLandmarksCheckbox.checked) {
                    drawConnectors(canvasCtx, handLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, handLandmarks, {color: '#FF0000', lineWidth: 2});
                }

            } else {
                statusElement.textContent = "ã‚«ãƒ¡ãƒ©ã«æ‰‹ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
            }

            canvasCtx.restore(); 
        });

        // ----------------------------------------------------
        // 5. ã‚«ãƒ¡ãƒ©ã®èµ·å‹•
        // ----------------------------------------------------

        // è§£åƒåº¦æŒ‡å®šã‚’å‰Šé™¤ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•èª¿æ•´ã«ä»»ã›ã‚‹
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒãƒ•ãƒ¬ãƒ¼ãƒ ã‚’MediaPipeã«é€ä¿¡
                await hands.send({image: videoElement});
            },
            // === ä¿®æ­£ç‚¹: width/heightã®å›ºå®šå€¤æŒ‡å®šã‚’å‰Šé™¤ ===
            // å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã«å¿œã˜ãŸæœ€é©ãªè§£åƒåº¦ã‚’é¸ã¶ã‚ˆã†ã«ãªã‚‹
            // ===========================================
        });
        camera.start();

        // æ˜ åƒã®æº–å‚™ãŒã§ããŸã‚‰ Canvas ã®ã‚µã‚¤ã‚ºã‚’åˆã‚ã›ã‚‹ (ã“ã“ã¯å¤‰æ›´ãªã—)
        videoElement.addEventListener('loadeddata', () => {
            // æ˜ åƒã®å®Ÿéš›ã®è§£åƒåº¦ã«åˆã‚ã›ã¦Canvasã‚µã‚¤ã‚ºã‚’æŸ”è»Ÿã«è¨­å®š
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            
            // CSSã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ#video-containerï¼‰ã®ç¸¦æ¨ªæ¯”ã‚‚æ˜ åƒã«åˆã‚ã›ã‚‹
            const container = document.getElementById('video-container');
            container.style.height = `${container.offsetWidth * (videoElement.videoHeight / videoElement.videoWidth)}px`;
        });
    </script>
</body>
</html>